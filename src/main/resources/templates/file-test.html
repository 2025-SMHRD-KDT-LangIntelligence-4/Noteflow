<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>파일 관리 테스트</title>
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #uploadArea { border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer; }

        .file-item { margin-bottom: 5px; padding: 5px; border: 1px solid #eee; }
        button { margin-left: 5px; }
    </style>
</head>
<body>
<h2>파일 업로드</h2>
<div id="uploadArea">
    드래그하거나 클릭하여 파일 선택
    <input type="file" id="fileInput" hidden>
</div>
<button id="uploadBtn">업로드</button>

<h2>업로드된 파일</h2>
<div>
    <button id="bulkDownload">ZIP 다운로드</button>
    <button id="bulkDelete">선택 삭제</button>
</div>
<div id="fileList"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let selectedIds = new Set();
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');


    // 순수 JavaScript + jQuery 조합으로 안전하게 처리
    document.addEventListener('DOMContentLoaded', function() {

        // CSRF 설정
        if (csrfToken && csrfHeader) {
            $.ajaxSetup({
            });
        }

        // 업로드 영역 이벤트
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', function() {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        });

        // 파일 선택 이벤트
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                uploadFile(this.files[0]);
                this.value = ''; // 초기화
            }
        });

        // 버튼 이벤트
        document.getElementById('uploadBtn').addEventListener('click', function() {
            fileInput.click();
        });

        document.getElementById('bulkDownload').addEventListener('click', bulkDownload);
        document.getElementById('bulkDelete').addEventListener('click', bulkDelete);

        // 초기 로드
        loadFiles();
    });

    function uploadFile(file) {
        if (!file) {
            alert('파일을 선택하세요.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        $.ajax({
            url: '/api/files/upload',
            method: 'POST',
            data: formData,

            headers: { [csrfHeader]: csrfToken },
            processData: false,
            contentType: false,
            success: function() {
                alert('업로드 완료');
                loadFiles();
            },
            error: function(xhr, status, error) {
                console.error('업로드 실패:', error);
                alert('업로드 실패');
            }
        });
    }

    function loadFiles() {
        selectedIds.clear();

        $.ajax({
            url: '/api/files/list',
            method: 'GET',

            headers: { [csrfHeader]: csrfToken },
            success: function(files) {
                const fileList = $('#fileList');
                fileList.empty();

                if (!files || files.length === 0) {
                    fileList.append('<p>등록된 파일이 없습니다.</p>');
                    return;
                }

                files.forEach(function(file) {
                    const fileItem = $(`
                            <div class="file-item">
                                <input type="checkbox" class="fileCheckbox" data-id="${file.id}">
                                <span>${file.originalName} (${file.size} bytes)</span>
                                <button onclick="downloadFile('${file.id}')">다운로드</button>
                                <button onclick="deleteFile('${file.id}')">삭제</button>
                            </div>
                        `);
                    fileList.append(fileItem);
                });

                // 체크박스 이벤트
                $('.fileCheckbox').on('change', function() {
                    const id = $(this).data('id');
                    if (this.checked) {
                        selectedIds.add(id);
                    } else {
                        selectedIds.delete(id);
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('파일 목록 로드 실패:', error);
                alert('파일 목록을 불러올 수 없습니다.');
            }
        });
    }

    function downloadFile(id) {
        window.location.href = `/api/files/download/${id}`;
    }

    function deleteFile(id) {
        if (!confirm('정말 삭제하시겠습니까?')) return;

        $.ajax({
            url: `/api/files/delete/${id}`,
            method: 'DELETE',
            headers: { [csrfHeader]: csrfToken },   // CSRF 헤더 추가
            success: function() {
                alert('삭제 완료');
                loadFiles();
            },
            error: function(xhr) {
                console.error('삭제 실패:', xhr);
                if (xhr.status === 403) {
                    alert('권한이 없거나 CSRF 토큰이 유효하지 않습니다.');
                } else {
                    alert('삭제 실패');
                }
            }
        });
    }

    function bulkDownload() {
        if (selectedIds.size === 0) {
            alert('선택된 파일이 없습니다.');
            return;
        }

        $.ajax({
            url: '/api/files/download-zip',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(Array.from(selectedIds)),

            headers: { [csrfHeader]: csrfToken },
            xhrFields: {
                responseType: 'blob'
            },
            success: function(blob) {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'files.zip';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
            error: function(xhr, status, error) {
                console.error('ZIP 다운로드 실패:', error);
                alert('ZIP 다운로드 실패');
            }
        });
    }

    function bulkDelete() {
        if (selectedIds.size === 0) {
            alert('선택된 파일이 없습니다.');
            return;
        }

        if (!confirm('선택된 파일들을 삭제하시겠습니까?')) return;

        const deletePromises = Array.from(selectedIds).map(function(id) {
            return $.ajax({
                url: `/api/files/delete/${id}`,
                method: 'DELETE',

                headers: { [csrfHeader]: csrfToken },
            });
        });

        Promise.all(deletePromises)
            .then(function() {
                alert('삭제 완료');
                loadFiles();
            })
            .catch(function(error) {
                console.error('삭제 중 오류:', error);
                alert('삭제 중 오류 발생');
            });
    }
</script>
</body>
</html>
