<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">

  <!-- CSRF -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />

  <!-- Toast UI Editor CDN (정상 URL / 태그 닫힘 주의) -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <style>
    /* 레이아웃 */
    .container { display: flex; gap: 20px; }
    .test-panel, .result-panel { flex: 1; min-width: 0; }
    .form-group { margin-bottom: 12px; }
    .btn { padding: 8px 12px; margin-top: 8px; cursor: pointer; }

    /* 입력 요소 */
    textarea { width: 100%; resize: vertical; }
    #editorContainer { height: 500px; border: 1px solid #ddd; margin-top: 10px; }

    /* Busy Overlay (LLM 처리 중 전체 비활성화 안내) */
    .busy-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .busy-overlay[hidden] { display: none; }
    .busy-box {
      background: #fff;
      border-radius: 8px;
      padding: 16px 20px;
      min-width: 260px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      text-align: center;
      font-size: 14px;
    }
    .spinner {
      width: 28px; height: 28px;
      border: 3px solid #e5e7eb; border-top-color: #3b82f6;
      border-radius: 50%;
      margin: 0 auto 10px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    body.busy { overflow: hidden; } /* 스크롤 잠금 */
  </style>
</head>
<body>
<div class="container">
  <!-- 테스트 입력 패널 -->
  <div class="test-panel">
    <h3>LLM 테스트</h3>

    <!-- 프롬프트 모드 -->
    <div class="form-group">
      <label>프롬프트 소스</label>
      <select id="promptMode" class="form-select">
        <option value="custom">커스텀</option>
        <option value="db" selected>DB 프롬프트</option>
      </select>
    </div>

    <!-- DB 프롬프트 선택 -->
    <div id="dbPromptWrap" class="form-group">
      <label>DB 프롬프트 선택</label>
      <select id="promptSelect" class="form-select">
        <option value="" disabled selected>선택</option>
        <option th:each="prompt : ${prompts}"
                th:value="${prompt.title}"
                th:text="${prompt.title}"
                th:data-content="${prompt.exampleOutput}"></option>
      </select>
    </div>

    <!-- 커스텀 프롬프트 입력 -->
    <div id="customPromptWrap" class="form-group" style="display:none;">
      <label>커스텀 프롬프트</label>
      <textarea id="customPrompt" rows="6" placeholder="LLM에게 줄 지시문을 작성하세요. 예: 출력 형식/섹션/금지 규칙 등"></textarea>
    </div>

    <!-- 원문 텍스트 -->
    <div class="form-group">
      <label>원문 텍스트</label>
      <textarea id="textContent" rows="8" placeholder="요약/가공할 텍스트를 입력하세요."></textarea>
    </div>

    <!-- 옵션 -->
    <div class="form-group">
      <label>옵션_ 토큰갯수 / temprature 온도 설정</label>
      <div style="display:flex; gap:10px;">
        <input id="maxTokens" type="number" class="form-control" th:value="${vllmApiMaxTokens}" placeholder="max_tokens">
        <input id="temperature" type="number" step="0.1" class="form-control" th:value="${vllmApiTemperature}" placeholder="temperature">
      </div>
    </div>

    <!-- 실행 버튼 -->
    <button id="testTextBtn" class="btn btn-primary">텍스트 테스트</button>

    <!-- 파일 업로드 -->
    <div class="form-group" style="margin-top:16px;">
      <label for="fileInput">파일 선택</label>
      <input type="file" id="fileInput" accept=".txt,.md,.pdf,.doc,.docx,.hwp,.hwpx">
    </div>
    <button id="testFileBtn" class="btn btn-secondary">파일 테스트</button>
  </div>

  <!-- 결과 패널 -->
  <div class="result-panel">
    <h3>결과</h3>
    <input id="resultTitle" placeholder="노트 제목" style="width:100%; margin-bottom:10px;">
    <div id="editorContainer"></div>
    <button id="saveBtn" class="btn btn-success" style="margin-top:10px;" disabled>저장</button>
  </div>
</div>

<!-- Busy Overlay (처리중 오버레이) -->
<div id="busyOverlay" class="busy-overlay" aria-live="polite" aria-busy="true" hidden>
  <div class="busy-box">
    <div class="spinner"></div>
    <div class="msg">LLM 처리 중입니다… 잠시만 기다려 주세요</div>
  </div>
</div>

<script th:inline="javascript">
  /* ===== 서버에서 내려주는 값 (fallback 포함) ===== */
  const csrfToken          = /*[[${_csrf.token}]]*/ '';
  const csrfHeader         = /*[[${_csrf.headerName}]]*/ '';
  const vllmApiMaxTokens   = /*[[${vllmApiMaxTokens}]]*/ 20000;
  const vllmApiTemperature = /*[[${vllmApiTemperature}]]*/ 0.5;

  /* ===== Toast UI Editor 초기화 ===== */
  const editor = new toastui.Editor({
    el: document.querySelector('#editorContainer'),
    height: '100%',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    language: 'ko',
    usageStatistics: false
  });

  /* ===== 모드 토글: DB vs 커스텀 ===== */
  const modeSel   = document.getElementById('promptMode');
  const dbWrap    = document.getElementById('dbPromptWrap');
  const customWrap= document.getElementById('customPromptWrap');
  modeSel.addEventListener('change', () => {
    const m = modeSel.value;
    dbWrap.style.display     = (m === 'db') ? '' : 'none';
    customWrap.style.display = (m === 'custom') ? '' : 'none';
  });

  /* ===== DB 프롬프트 선택 시 예시 출력 ===== */
  const promptSelect = document.getElementById('promptSelect');
  if (promptSelect) {
    promptSelect.addEventListener('change', (e) => {
      const selected = e.target.selectedOptions[0];
      const example  = selected?.dataset?.content || '';
      editor.setMarkdown(example);
    });
  }

  /* ===== 인터랙티브 요소 목록 (일괄 비활성화 대상) ===== */
  const interactiveEls = [
    '#promptMode', '#promptSelect', '#customPrompt',
    '#textContent', '#maxTokens', '#temperature',
    '#testTextBtn', '#fileInput', '#testFileBtn',
    '#resultTitle', '#saveBtn'
  ].map(sel => document.querySelector(sel)).filter(Boolean);

  /* ===== Busy 상태 토글 + 오버레이 ===== */
  function setBusy(isBusy) {
    interactiveEls.forEach(el => {
      const tag = el.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') {
        if (el.id === 'resultTitle') el.readOnly = isBusy; // 제목 필드는 readOnly
        else el.disabled = isBusy;                          // 나머지 입력/선택/버튼 disabled
      } else {
        el.disabled = isBusy;
      }
    });
    const overlay = document.getElementById('busyOverlay');
    if (overlay) overlay.hidden = !isBusy;
    document.body.classList.toggle('busy', isBusy);
  }

  /* ===== Busy 래퍼 (비동기 작업에 공통 적용) ===== */
  async function withBusy(fn) {
    try { setBusy(true); await fn(); }
    finally { setBusy(false); }
  }

  /* ===== 저장 ===== */
  const saveBtn = document.getElementById('saveBtn');
  saveBtn.addEventListener('click', () => {
    withBusy(async () => {
      const payload = {
        title: document.getElementById('resultTitle').value.trim() || '자동생성 노트',
        summary: editor.getMarkdown(),
        promptId: '0' // 필요 시 실제 promptId 매핑
      };
      const res = await fetch('/notion/save-note', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      alert(result.success ? `저장 완료: ID ${result.noteId}` : `저장 실패: ${result.error}`);
    });
  });

  /* ===== 텍스트 테스트 ===== */
  const testTextBtn = document.getElementById('testTextBtn');
  testTextBtn.addEventListener('click', () => {
    withBusy(async () => {
      const mode        = document.getElementById('promptMode').value;
      const promptTitle = document.getElementById('promptSelect').value;
      const customPrompt= document.getElementById('customPrompt').value.trim();
      const content     = document.getElementById('textContent').value.trim();
      const maxTokens   = Number(document.getElementById('maxTokens').value || vllmApiMaxTokens);
      const temperature = Number(document.getElementById('temperature').value || vllmApiTemperature);

      if (!content) { alert('텍스트를 입력해주세요'); return; }
      if (mode === 'db' && !promptTitle) { alert('DB 프롬프트를 선택해주세요'); return; }
      if (mode === 'custom' && !customPrompt) { alert('커스텀 프롬프트를 입력해주세요'); return; }

      const body = { promptMode: mode, promptTitle, customPrompt, content, maxTokens, temperature };
      const res  = await fetch('/test/llm/text', {
        method: 'POST',
        headers: { 'Content-Type':'application/json;charset=UTF-8', [csrfHeader]: csrfToken },
        body: JSON.stringify(body)
      });
      const json = await res.json();
      if (json.success) {
        editor.setMarkdown(json.summary || '');
        saveBtn.disabled = false;
      } else {
        alert(json.error || json.message);
      }
    });
  });

  /* ===== 파일 테스트 ===== */
  const testFileBtn = document.getElementById('testFileBtn');
  testFileBtn.addEventListener('click', () => {
    withBusy(async () => {
      const mode        = document.getElementById('promptMode').value;
      const promptTitle = document.getElementById('promptSelect').value;
      const customPrompt= document.getElementById('customPrompt').value.trim();
      const file        = document.getElementById('fileInput').files[0];
      const maxTokens   = Number(document.getElementById('maxTokens').value || vllmApiMaxTokens);
      const temperature = Number(document.getElementById('temperature').value || vllmApiTemperature);

      if (!file) { alert('파일을 선택해주세요'); return; }
      if (mode === 'db' && !promptTitle) { alert('DB 프롬프트를 선택해주세요'); return; }
      if (mode === 'custom' && !customPrompt) { alert('커스텀 프롬프트를 입력해주세요'); return; }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('promptMode', mode);
      formData.append('promptTitle', promptTitle);
      formData.append('customPrompt', customPrompt);
      formData.append('maxTokens', maxTokens);
      formData.append('temperature', temperature);

      const res  = await fetch('/test/llm/file', {
        method: 'POST',
        headers: { [csrfHeader]: csrfToken },
        body: formData
      });
      const json = await res.json();
      if (json.success) {
        editor.setMarkdown(json.summary || '');
        saveBtn.disabled = false;
      } else {
        alert(json.error || json.message);
      }
    });
  });
</script>
</body>
</html>