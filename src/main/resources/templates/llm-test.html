<!-- src/main/resources/templates/llm-test.html -->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">

  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <style>
    .container { display: flex; }


    textarea { height: 600px; resize: both; }


    #editorContainer { height: 500px; border: 1px solid #ddd; margin-bottom: 10px; }
  </style>
</head>
<body>

<div class="container">
  <div class="test-panel">
    <div class="form-group">
      <select id="promptSelect">
        <option value="" disabled selected>선택</option>
        <option th:each="prompt : ${prompts}"
                th:value="${prompt.title}"
                th:text="${prompt.title}"
                th:data-content="${prompt.exampleOutput}"></option>
      </select>
    </div>
    텍스트
    <div class="form-group">
      <textarea id="textContent" placeholder="내용입력"></textarea>
    </div>
    <button id="testTextBtn">으아아아아</button><br>
    <div class="form-group">
      <label for="fileInput">파일 선택</label><br>
      <input type="file" id="fileInput" accept=".txt,.pdf" />
    </div>
    <button id="testFileBtn">파일 테스트 </button>
  </div>

  <div class="result-panel">

    제목<input id="resultTitle" >
    <div id="editorContainer"></div>
    <button id="saveBtn" >저장</button>
  </div>
</div>

<script th:inline="javascript">
  const csrfToken         = /*[[${_csrf.token}]]*/ '';
  const csrfHeader        = /*[[${_csrf.headerName}]]*/ '';
  const vllmApiMaxTokens  = /*[[${vllmApiMaxTokens}]]*/ 30000;
  const vllmApiTemperature = /*[[${vllmApiTemperature}]]*/ 0.5;


  const editor = new toastui.Editor({
    el: document.querySelector('#editorContainer'),
    height: '100%',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    language: 'ko',
    usageStatistics: false
  });
  document.getElementById('promptSelect').addEventListener('change', (e) => {
    const selected = e.target.selectedOptions[0];
    const example  = selected.dataset.content || '';
    editor.setMarkdown(example);
  });

  // 저장 버튼 클릭
  document.getElementById('saveBtn').addEventListener('click', async () => {
    const promptTitle = document.getElementById('promptSelect').value;
    const markdown    = editor.getMarkdown();
    const payload = {
      title: document.getElementById('resultTitle').value.trim() || '자동생성 노트',
      summary: markdown,
      promptId: '3'
    };
    const res = await fetch('/notion/save-note', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        [csrfHeader]: csrfToken
      },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    alert(result.success ? `저장 완료: ID ${result.noteId}` : `저장 실패: ${result.error}`);
  });

  // 텍스트
  document.getElementById('testTextBtn').addEventListener('click', async () => {
    const promptTitle = document.getElementById('promptSelect').value;
    const content     = document.getElementById('textContent').value.trim();
    if (!promptTitle) { alert('프롬프트를 선택해주세요'); return; }
    if (!content)     { alert('텍스트를 입력해주세요'); return; }

    const res  = await fetch('/test/llm/text', {
      method: 'POST',
      headers: {
        'Content-Type':'application/json;charset=UTF-8',
        [csrfHeader]: csrfToken
      },
      body: JSON.stringify({ promptTitle, content, max_tokens: vllmApiMaxTokens, temperature: vllmApiTemperature })
    });
    const json = await res.json();
    if (json.success) {
      editor.setMarkdown(json.summary || '');
      document.getElementById('saveBtn').disabled = false;
    } else {
      alert(json.error || json.message);
    }
  });

  // 파일
  document.getElementById('testFileBtn').addEventListener('click', async () => {
    const promptTitle = document.getElementById('promptSelect').value;
    const fileInput   = document.getElementById('fileInput');
    const file        = fileInput.files[0];
    if (!promptTitle) { alert('프롬프트를 선택해주세요'); return; }
    if (!file)        { alert('파일을 선택해주세요'); return; }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('promptTitle', promptTitle);

    const res  = await fetch('/test/llm/file', {
      method: 'POST',
      headers: { [csrfHeader]: csrfToken },
      body: formData
    });
    const json = await res.json();
    if (json.success) {
      editor.setMarkdown(json.summary || '');
      document.getElementById('saveBtn').disabled = false;
    } else {
      alert(json.error || json.message);
    }
  });
</script>
</body>
</html>
