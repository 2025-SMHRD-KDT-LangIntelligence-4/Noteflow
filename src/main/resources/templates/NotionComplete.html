<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
    <meta name="csrf" th:content="${_csrf?.token}">
    <meta name="csrf-header" th:content="${_csrf?.headerName}">
<link rel="stylesheet" th:href="@{/css/header.css}" />
<link rel="stylesheet" th:href="@{/css/notioncomplete.css}" />
<link rel="stylesheet" th:href="@{/css/footer.css}" />
</head>
<body>
<!-- í—¤ë” -->
<div th:replace="~{fragments/header :: siteHeader}"></div>

<div class="message-container">
<div class="message-box">
<!-- ë©”ì‹œì§€ -->
<div class="message">ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>

<div class="AI-model-box-location-container">
<!-- AI ì´ë¯¸ì§€ -->
<div class="AI-model-box">
<img th:src="@{/images/AI.png}" class="AI-image">
</div>

<!-- ì œëª© -->
<div class="title">
<span th:text="${title != null ? title : 'ë…¸ì„  ì œëª©'}">ë…¸ì„  ì œëª©</span>
</div>

<!-- ì‘ì„±ì¼ -->
<div class="date">
<span th:text="${createdAt != null ? createdAt : 'ë…¸ì„  ì‘ì„±ì¼'}">ë…¸ì„  ì‘ì„±ì¼</span>
</div>

<!-- í‚¤ì›Œë“œ (id ì¶”ê°€) -->
<div class="info-line">
<strong>í‚¤ì›Œë“œ:</strong> 
<span id="nc-keywords" th:text="${keywords != null ? keywords : 'ì—†ìŒ'}">í‚¤ì›Œë“œ</span>
</div>

<!-- í´ë” ê²½ë¡œ (id ì¶”ê°€) -->
<div class="info-line">
<strong>í´ë” ê²½ë¡œ:</strong> 
<span id="nc-folder" th:text="${categoryPath != null ? categoryPath : 'ì—†ìŒ'}">ì—†ìŒ</span>
</div>

<!-- ë²„íŠ¼ë“¤ (ê°€ë¡œ ë°°ì¹˜) -->
<div class="button-location-container">
<!-- href="#" ìœ¼ë¡œ ë³€ê²½í•˜ê³  id ì¶”ê°€ -->
<a href="#" id="nc-go-lecture">ê°•ì˜í˜ì´ì§€</a>
<a th:href="@{/notion/create}" class="action-btn">ì‘ì„±í˜ì´ì§€ë¡œ</a>
<a th:href="@{/notion/manage}" class="action-btn">ë…¸ì…˜ ê´€ë¦¬</a>
    <a href="#" id="nc-go-exam">ğŸ“ ë¬¸ì œì€í–‰ ê°€ê¸°</a>
    <input type="hidden" id="nc-note-id" th:value="${noteId}">
<a th:href="@{/main}" class="action-btn">ë©”ì¸ìœ¼ë¡œ</a>
</div>
</div>
</div>
</div>

<!-- í‘¸í„° -->
<div th:replace="~{fragments/footer :: siteFooter}"></div>

<!-- JavaScript ì½”ë“œ ì¶”ê°€ -->
<script>
    // CSRF í† í° í•¨ìˆ˜
    function getCsrfToken() {
        return document.querySelector('meta[name="csrf"]')?.content || '';
    }

    function getCsrfHeader() {
        return document.querySelector('meta[name="csrf-header"]')?.content || 'X-CSRF-TOKEN';
    }

    console.log('CSRF ì •ë³´:', {
        token: getCsrfToken() ? 'ìˆìŒ' : 'ì—†ìŒ',
        header: getCsrfHeader()
    });

    // ê°•ì˜ ì¶”ì²œ ê¸°ëŠ¥
    document.getElementById('nc-go-lecture')?.addEventListener('click', function(ev) {
        ev.preventDefault();

        const kwText = document.getElementById('nc-keywords')?.textContent?.trim();
        const folder = document.getElementById('nc-folder')?.textContent?.trim();
        const keyword = kwText ? kwText : '';
        const folderPath = folder ? folder : '';
        const cat = folderPath.split('/').map(s => s.trim()).filter(Boolean);

        let payload = null;
        if (keyword) {
            if (/,/.test(keyword)) {
                const tags = keyword.split(',').map(s => s.replace(/[#]/g, '').trim()).filter(Boolean);
                payload = { tags, like: false, size: 30 };
            } else {
                payload = { keyword: keyword, size: 30 };
            }
        } else if (cat.length) {
            payload = {
                category: { large: cat[0] || null, medium: cat[1] || null, small: cat[2] || null },
                size: 30
            };
        }

        try {
            if (payload) {
                sessionStorage.setItem('lectureRecommendPayload', JSON.stringify(payload));
            }
        } catch (e) {
            console.error('sessionStorage ì˜¤ë¥˜:', e);
        }

        window.location.href = '/lecture';
    });

    // ë¬¸ì œì€í–‰ ê°€ê¸° (POST ë°©ì‹)
    document.getElementById('nc-go-exam')?.addEventListener('click', async function(ev) {
        ev.preventDefault();

        const noteIdElement = document.getElementById('nc-note-id');
        const noteId = noteIdElement?.value;

        const title = document.querySelector('.title span')?.textContent?.trim() || 'ìƒˆ ë…¸íŠ¸';
        const kwText = document.getElementById('nc-keywords')?.textContent?.trim() || '';

        // í‚¤ì›Œë“œ íŒŒì‹±
        let keywords = [];
        if (kwText) {
            if (/,/.test(kwText)) {
                keywords = kwText.split(',').map(s => s.replace(/[#]/g, '').trim()).filter(Boolean);
            } else {
                keywords = [kwText.replace(/[#]/g, '').trim()];
            }
        }

        // noteIdx ë³€í™˜ (ì•ˆì „í•˜ê²Œ)
        let noteIdx = null;
        if (noteId && noteId !== '' && noteId !== 'null' && noteId !== 'undefined') {
            const parsed = parseInt(noteId, 10);
            if (!isNaN(parsed)) {
                noteIdx = parsed;
            }
        }

        try {
            const csrfToken = getCsrfToken();
            const csrfHeader = getCsrfHeader();

            const headers = {
                'Content-Type': 'application/json'
            };

            if (csrfToken) {
                headers[csrfHeader] = csrfToken;
            }

            const requestBody = {
                noteIdx: noteIdx,
                noteTitle: title,
                keywords: keywords
            };

            const response = await fetch('/exam/prepare-from-note', {
                method: 'POST',
                headers: headers,
                credentials: 'include',
                body: JSON.stringify(requestBody)
            });

            console.log('ì‘ë‹µ ìƒíƒœ:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('ì‘ë‹µ ì—ëŸ¬:', errorText);
                throw new Error('HTTP ' + response.status);
            }

            const result = await response.json();
            console.log('ì‘ë‹µ ê²°ê³¼:', result);

            if (result.success) {
                window.location.href = '/exam/create';
            } else {
                alert('ì˜¤ë¥˜: ' + result.message);
            }

        } catch (error) {
            console.error('ë¬¸ì œì€í–‰ ì´ë™ ì‹¤íŒ¨:', error);
            alert('ë¬¸ì œì€í–‰ìœ¼ë¡œ ì´ë™í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    });
</script>


</body>
</html>
