<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<link rel="stylesheet" th:href="@{/css/header.css}" />
<link rel="stylesheet" id="theme-css" th:href="@{/css/notioncomplete.css}" />
<link rel="stylesheet" th:href="@{/css/footer.css}" />
<script>
		document.addEventListener("DOMContentLoaded", () => {
		  const themeLink = document.getElementById("theme-css");
		  const themeToggleBtn = document.getElementById("theme-toggle-btn");
		
		  // 저장된 모드 불러오기
		  const savedTheme = localStorage.getItem("theme") || "light";
		
		  // 로그인 여부 확인 (버튼이 없으면 로그아웃 상태로 판단)
		  const isLoggedIn = !!themeToggleBtn;
		
		  if (isLoggedIn) {
		    // 로그인 상태에서는 저장된 테마 적용
		    applyTheme(savedTheme);
		
		    // 버튼 클릭 시 다크모드 전환
		    themeToggleBtn.addEventListener("click", () => {
		      const current = localStorage.getItem("theme") || "light";
		      const next = current === "light" ? "dark" : "light";
		      applyTheme(next);
		    });
		  } else {
		    // 로그아웃 상태에서는 항상 라이트모드 적용
		    applyTheme("light");
		  }
		
		  // ✅ 테마 적용 함수
		  function applyTheme(mode) {
		    if (mode === "dark") {
		      themeLink.setAttribute("href", "/CSSDARK/notionComplete.css");
		      localStorage.setItem("theme", "dark");
		      if (themeToggleBtn) {
		        themeToggleBtn.classList.add("dark"); // 버튼 이동 클래스 추가
		      }
		    } else {
		      themeLink.setAttribute("href", "/css/notionComplete.css");
		      localStorage.setItem("theme", "light");
		      if (themeToggleBtn) {
		        themeToggleBtn.classList.remove("dark"); // 기본 위치로 복귀
		      }
		    }
		  }
		});
	</script> 
</head>
<body>
<!-- 헤더 -->
<div th:replace="~{fragments/header :: siteHeader}"></div>

<div class="message-container">
<div class="message-box">
<!-- 메시지 -->
<div class="message">저장이 완료되었습니다.</div>

<div class="AI-model-box-location-container">
<!-- AI 이미지 -->
<div class="AI-model-box">
<img th:src="@{/images/AI.png}" class="AI-image">
</div>

<!-- 제목 -->
<div class="title">
<span th:text="${title != null ? title : '노트제목'}">노트제목</span>
</div>

<!-- 작성일 -->
<div class="date">
<span th:text="${createdAt != null ? createdAt : '노트 작성일'}">노트 작성일</span>
</div>

<!-- 키워드 (id 추가) -->
<div class="info-line">
<strong>키워드:</strong> 
<span id="nc-keywords" th:text="${keywords != null ? keywords : '없음'}">키워드</span>
</div>

<!-- 폴더 경로 (id 추가) -->
<div class="info-line">
<strong>폴더 경로:</strong> 
<span id="nc-folder" th:text="${categoryPath != null ? categoryPath : '없음'}">없음</span>
</div>

<!-- 버튼들 (가로 배치) -->
<div class="button-location-container">
<!-- href="#" 으로 변경하고 id 추가 -->
<a href="#" id="nc-go-lecture">강의페이지</a>
<a th:href="@{/notion/precreate}" class="action-btn">작성페이지로</a>
<a th:href="@{/notion/manage}" class="action-btn">노트관리</a>
    <a href="#" id="nc-go-exam">문제은행 가기</a>
    <input type="hidden" id="nc-note-id" th:value="${noteId}">
</div>
</div>
</div>
</div>

<!-- 푸터 -->
<div th:replace="~{fragments/footer :: siteFooter}"></div>

<script>
    // 강의 추천 기능
    document.getElementById('nc-go-lecture')?.addEventListener('click', function(ev) {
        ev.preventDefault();

        const kwText = document.getElementById('nc-keywords')?.textContent?.trim();
        const folder = document.getElementById('nc-folder')?.textContent?.trim();
        const keyword = kwText ? kwText : '';
        const folderPath = folder ? folder : '';
        const cat = folderPath.split('/').map(s => s.trim()).filter(Boolean);

        let payload = null;
        if (keyword) {
            if (/,/.test(keyword)) {
                const tags = keyword.split(',').map(s => s.replace(/[#]/g, '').trim()).filter(Boolean);
                payload = { tags, like: false, size: 30 };
            } else {
                payload = { keyword: keyword, size: 30 };
            }
        } else if (cat.length) {
            payload = {
                category: { large: cat[0] || null, medium: cat[1] || null, small: cat[2] || null },
                size: 30
            };
        }

        try {
            if (payload) {
                sessionStorage.setItem('lectureRecommendPayload', JSON.stringify(payload));
            }
        } catch (e) {
            console.error('sessionStorage 오류:', e);
        }

        window.location.href = '/lecture';
    });

    // 문제은행 가기 (POST 방식)
    document.getElementById('nc-go-exam')?.addEventListener('click', async function(ev) {
        ev.preventDefault();

        const noteIdElement = document.getElementById('nc-note-id');
        const noteId = noteIdElement?.value;

        const title = document.querySelector('.title span')?.textContent?.trim() || '새 노트';
        const kwText = document.getElementById('nc-keywords')?.textContent?.trim() || '';

        // 키워드 파싱
        let keywords = [];
        if (kwText) {
            if (/,/.test(kwText)) {
                keywords = kwText.split(',').map(s => s.replace(/[#]/g, '').trim()).filter(Boolean);
            } else {
                keywords = [kwText.replace(/[#]/g, '').trim()];
            }
        }

        // noteIdx 변환 (안전하게)
        let noteIdx = null;
        if (noteId && noteId !== '' && noteId !== 'null' && noteId !== 'undefined') {
            const parsed = parseInt(noteId, 10);
            if (!isNaN(parsed)) {
                noteIdx = parsed;
            }
        }

        try {
            const csrfToken = getCsrfToken();
            const csrfHeader = getCsrfHeader();

            const headers = {
                'Content-Type': 'application/json'
            };

            if (csrfToken) {
                headers[csrfHeader] = csrfToken;
            }

            const requestBody = {
                noteIdx: noteIdx,
                noteTitle: title,
                keywords: keywords
            };

            const response = await fetch('/exam/prepare-from-note', {
                method: 'POST',
                headers: headers,
                credentials: 'include',
                body: JSON.stringify(requestBody)
            });

            console.log('응답 상태:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('응답 에러:', errorText);
                throw new Error('HTTP ' + response.status);
            }

            const result = await response.json();
            console.log('응답 결과:', result);

            if (result.success) {
                window.location.href = '/exam/create';
            } else {
                alert('오류: ' + result.message);
            }

        } catch (error) {
            console.error('문제은행 이동 실패:', error);
            alert('문제은행으로 이동하는 중 오류가 발생했습니다: ' + error.message);
        }
    });
</script>


</body>
</html>
