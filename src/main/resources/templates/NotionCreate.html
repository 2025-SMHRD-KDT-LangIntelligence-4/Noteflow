<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ì…˜ ìž‘ì„±</title>

    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- âœ… CSS -->
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <link rel="stylesheet" th:href="@{/css/notionCreate.css}" />
    <link rel="stylesheet" th:href="@{/css/ckEditor.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />

    <!-- âœ… ë°˜ë“œì‹œ ë¨¼ì € CKEditor ë³¸ì²´ ë¡œë“œ -->
    <script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>
</head>

<body>
<div th:replace="fragments/header :: siteHeader"></div>

<div class="full-container">
    <div class="slide-location-container">
        <div class="slide-container">
            <button class="arrow left">â€¹</button>
            <div class="slider-wrapper">
                <div class="button-container" id="buttonContainer"></div>
            </div>
            <button class="arrow right">â€º</button>
        </div>
    </div>

    <div class="text-container">
        <div class="input-location-container">
            <div class="input-container">
                <input class="title" id="inputTitle" placeholder="ì˜¤ëŠ˜ í•™ìŠµí•œ ë‚´ìš©ì˜ ì œëª©ì„ ìž…ë ¥í•˜ì„¸ìš”" />
                <textarea class="notion-text" id="inputContent" placeholder="ì—¬ê¸°ì— í•™ìŠµ ë‚´ìš©, ì½”ë“œ, ë¡œê·¸ ë“±ì„ ìžìœ ë¡­ê²Œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
                <div style="display:flex; gap:20px;">
	                <button class="submit-button" id="generateBtn">ìž‘ì„±</button>
	                <button class="submit-button" id="generateBtn">ì—…ë¡œë“œ</button>
                </div>
            </div>
        </div>

        <div class="result-location-container">
            <div class="result-container">
                <input class="result-title" id="resultTitle" placeholder="AI ìš”ì•½ ê²°ê³¼ ì œëª©" />
                <div class="main-container">
                    <div class="editor-container editor-container_classic-editor" id="editor-container">
                        <div id="editor"></div>
                    </div>
                </div>
                <button class="save-button" id="saveBtn">ì €ìž¥</button>
            </div>
        </div>
    </div>
</div>

<!-- âœ… ckEditor.jsëŠ” ë°˜ë“œì‹œ ClassicEditor ë¡œë“œ ì´í›„ ì‹¤í–‰ -->
<script th:src="@{/js/ckEditor.js}"></script>

<script th:inline="javascript">
	const image = /*[[@{${image}}]]*/ "";
    document.addEventListener("DOMContentLoaded", (format, data) => {
        // --- CSRF í† í° ì„¤ì • ---
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        // --- ì „ì—­ ë³€ìˆ˜ ë° ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const prompts = /*[[${prompts}]]*/ [];
        const container = document.getElementById("buttonContainer");
        let selectedPromptTitle = "ì‹¬í”Œë²„ì „"; // ê¸°ë³¸ê°’
        let editor;

        // --- CKEditor ì´ˆê¸°í™” ---
        ClassicEditor
            .create(document.querySelector('#editor'), {
                language: 'ko',
                placeholder: 'AIê°€ ìƒì„±í•œ ìš”ì•½ë³¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ìžìœ ë¡­ê²Œ íŽ¸ì§‘í•˜ì„¸ìš”!'
            })
            .then(newEditor => {
                editor = newEditor;

                // ðŸ”¥ ê¸°ë³¸ ì‹¬í”Œë²„ì „ì˜ ì˜ˆì‹œë¥¼ CKEditorì— í‘œì‹œ
                const defaultPrompt = prompts.find(p => p.title === "ì‹¬í”Œë²„ì „");
                if (defaultPrompt && defaultPrompt.exampleOutput) {
                    editor.setData(defaultPrompt.exampleOutput, data);
                }
            })
            .catch(error => {
                console.error('CKEditor ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            });

        // --- ìŠ¬ë¼ì´ë“œ ë²„íŠ¼ ë™ì  ìƒì„± ---
        prompts.forEach(prompt => {
            const btn = document.createElement("div");
            btn.className = "slide-btn";
            btn.dataset.promptTitle = prompt.title;
            btn.dataset.exampleOutput = prompt.exampleOutput; // 'example_ouptput' ì˜¤íƒ€ ìˆ˜ì •
            btn.innerHTML = ` <img src="${image}" alt="${prompt.title}" class="slide-icon" />
            	  <span class="kor">${prompt.title}</span>`;

            // ê¸°ë³¸ 'ì‹¬í”Œë²„ì „' ì„ íƒ
            if (prompt.title === selectedPromptTitle) {
                btn.classList.add('active');
            }

            btn.addEventListener('click', (format, data) => {
                document.querySelectorAll('.slide-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedPromptTitle = btn.dataset.promptTitle;

                // ðŸ”¥ ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ í”„ë¡¬í”„íŠ¸ì˜ ì˜ˆì‹œë¥¼ CKEditorì— í‘œì‹œ
                editor.setData(btn.dataset.exampleOutput, data);
            });
            container.appendChild(btn);
        });

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        const generateBtn = document.getElementById('generateBtn');
        const saveBtn = document.getElementById('saveBtn');

        generateBtn.addEventListener('click', handleGenerate);
        saveBtn.addEventListener('click', handleSave);

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ ---
        async function handleGenerate() {
            const title = document.getElementById('inputTitle').value.trim();
            const content = document.getElementById('inputContent').value.trim();

            if (!title || !content) {
                alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ìž…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            generateBtn.textContent = 'AI ìš”ì•½ ì¤‘...';
            generateBtn.disabled = true;

            try {
                const response = await fetch('/api/notion/generate-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({
                        content: content,
                        notionType: selectedPromptTitle
                    })
                });

                if (!response.ok) throw new Error('AI ìš”ì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                document.getElementById('resultTitle').value = title;
                editor.setData(result.summary);

            } catch (error) {
                console.error('ìš”ì•½ ìƒì„± ì˜¤ë¥˜:', error);
                alert('ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                generateBtn.textContent = 'ìž‘ì„±';
                generateBtn.disabled = false;
            }
        }

        async function handleSave() {
            const title = document.getElementById('resultTitle').value.trim();
            const content = editor.getData();

            if (!title || !content) {
                alert('ì €ìž¥í•  ì œëª©ê³¼ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            saveBtn.textContent = 'ì €ìž¥ ì¤‘...';
            saveBtn.disabled = true;

            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({ title, content })
                });

                if (!response.ok) throw new Error('ì €ìž¥ ì‹¤íŒ¨');

                const result = await response.json();
                if (result.success) {
                    alert('ë…¸íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    window.location.href = '/notion/manage'; // ì €ìž¥ í›„ ê´€ë¦¬ íŽ˜ì´ì§€ë¡œ ì´ë™
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error('ì €ìž¥ ì˜¤ë¥˜:', error);
                alert('ì €ìž¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                saveBtn.textContent = 'ì €ìž¥';
                saveBtn.disabled = false;
            }
        }

        // --- ìŠ¬ë¼ì´ë“œ UI ë¡œì§ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€) ---
        const slider = document.querySelector(".slide-container");
        const track = document.querySelector(".slider-wrapper");
        const leftBtn = document.querySelector(".arrow.left");
        const rightBtn = document.querySelector(".arrow.right");

        leftBtn.addEventListener("click", () => track.scrollBy({ left: -300, behavior: "smooth" }));
        rightBtn.addEventListener("click", () => track.scrollBy({ left: 300, behavior: "smooth" }));
        track.addEventListener("wheel", (e) => {
            e.preventDefault();
            track.scrollBy({ left: e.deltaY, behavior: "smooth" });
        });
        // ë²„íŠ¼ ë³µì œí•˜ì—¬ ë¬´í•œë£¨í”„ êµ¬í˜„
	  	const originalButtons = Array.from(container.children);
	  	for (let i = 0; i < 3; i++) {
	  	  originalButtons.forEach(btn => container.appendChild(btn.cloneNode(true)));
	  	}
	  	// ìžë™ ìŠ¬ë¼ì´ë“œ ë³€ìˆ˜
	  	let scrollSpeed = 0.8;
	  	let isPaused = false;
	  	const originalSetWidth = originalButtons.reduce((acc, btn) => acc + btn.offsetWidth + 20, 0);
	  	// ìžë™ ìŠ¬ë¼ì´ë“œ í•¨ìˆ˜
	  	function animate() {
	  	  if (!isPaused) {
	  	    track.scrollLeft += scrollSpeed;
	  	    if (track.scrollLeft >= originalSetWidth) {
	  	      track.scrollLeft = 0;
	  	    }
	  	  }
	  	  requestAnimationFrame(animate);
	  	}
	  	animate();
	  	// ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì¼ì‹œì •ì§€
		slider.addEventListener("mouseenter", () => isPaused = true);
		slider.addEventListener("mouseleave", () => isPaused = false);
  	
  	  
  	
  	

		
    });
    
</script>

<div th:replace="fragments/footer :: siteFooter"></div>
</body>
</html>