<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹œí—˜ ê²°ê³¼</title>
<link id="theme-css" rel="stylesheet" th:href="@{/css/quizResult.css}">
<script>
		document.addEventListener("DOMContentLoaded", () => {
		  const themeLink = document.getElementById("theme-css");
		  const themeToggleBtn = document.getElementById("theme-toggle-btn");
		
		  // ì €ì¥ëœ ëª¨ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
		  const savedTheme = localStorage.getItem("theme") || "light";
		
		  // ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ (ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì•„ì›ƒ ìƒíƒœë¡œ íŒë‹¨)
		  const isLoggedIn = !!themeToggleBtn;
		
		  if (isLoggedIn) {
		    // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ì €ì¥ëœ í…Œë§ˆ ì ìš©
		    applyTheme(savedTheme);
		
		    // ë²„íŠ¼ í´ë¦­ ì‹œ ë‹¤í¬ëª¨ë“œ ì „í™˜
		    themeToggleBtn.addEventListener("click", () => {
		      const current = localStorage.getItem("theme") || "light";
		      const next = current === "light" ? "dark" : "light";
		      applyTheme(next);
		    });
		  } else {
		    // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” í•­ìƒ ë¼ì´íŠ¸ëª¨ë“œ ì ìš©
		    applyTheme("light");
		  }
		
		  // âœ… í…Œë§ˆ ì ìš© í•¨ìˆ˜
		  function applyTheme(mode) {
		    if (mode === "dark") {
		      themeLink.setAttribute("href", "/CSSDARK/quizResult.css");
		      localStorage.setItem("theme", "dark");
		      if (themeToggleBtn) {
		        themeToggleBtn.classList.add("dark"); // ë²„íŠ¼ ì´ë™ í´ë˜ìŠ¤ ì¶”ê°€
		      }
		    } else {
		      themeLink.setAttribute("href", "/css/quizResult.css");
		      localStorage.setItem("theme", "light");
		      if (themeToggleBtn) {
		        themeToggleBtn.classList.remove("dark"); // ê¸°ë³¸ ìœ„ì¹˜ë¡œ ë³µê·€
		      }
		    }
		  }
		});
	</script>
    
<link rel="stylesheet" th:href="@{/css/header.css}">
<link rel="stylesheet" th:href="@{/css/footer.css}">
</head>
<body>
	<!-- Header í¬í•¨ -->
	<div th:replace="~{fragments/header :: header}"></div>

	<div class="page-wrapper">
		<div class="result-container">
			<!-- ìƒë‹¨: ì œëª© & ì ìˆ˜ -->
			<div class="result-header">
				<h1 class="result-title">ì‹œí—˜ ê²°ê³¼</h1>
				<div class="score-display">
					<div class="score-main">
						<span class="score-number" th:text="${result.correctCount}">0</span>
						<span class="score-divider">/</span> <span class="score-total"
							th:text="${result.correctCount + result.wrongCount}">0</span>
					</div>
					<div class="score-percentage"
						th:text="${#numbers.formatDecimal((result.correctCount * 100.0) / (result.correctCount + result.wrongCount), 1, 1)} + '%'">0%</div>
				</div>
			</div>

			<!-- ë¬¸ì œë³„ ì •ì˜¤ í‘œì‹œ -->
			<div class="answer-summary">
				<h2 class="section-title">ë¬¸ì œë³„ ê²°ê³¼</h2>
				<div class="answer-grid">
					<div th:each="answer, stat : ${userAnswers}" class="answer-item"
						th:classappend="${answer.isCorrect} ? 'correct' : 'wrong'">
						<span class="question-num" th:text="${stat.index + 1}">1</span> <span
							class="answer-mark" th:text="${answer.isCorrect} ? 'O' : 'X'">O</span>
					</div>
				</div>
			</div>

			<!-- ê³¼ëª©ë³„ í†µê³„ -->
			<div class="subject-stats">
				<h2 class="section-title">ê³¼ëª©ë³„ í†µê³„</h2>
				<table class="stats-table">
					<thead>
						<tr>
							<th>ê³¼ëª©</th>
							<th>ë¬¸ì œ ìˆ˜</th>
							<th>ì •ë‹µ ìˆ˜</th>
							<th>ì •ë‹µë¥ </th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="stat : ${subjectStats}">
							<td th:text="${stat.subject}">ê³¼ëª©ëª…</td>
							<td th:text="${stat.totalCount}">0</td>
							<td th:text="${stat.correctCount}">0</td>
							<td
								th:text="${#numbers.formatDecimal(stat.accuracy * 100, 1, 1)} + '%'">0%</td>
						</tr>
					</tbody>
				</table>
			</div>

			<!-- ê³¼ëª© ë¶„ì„ -->
			<div class="subject-analysis">
				<div class="weak-subjects">
					<h3>ì·¨ì•½ ê³¼ëª©</h3>
					<div class="subject-tags">
						<span th:each="subject : ${weakSubjects}" class="subject-tag weak"
							th:text="${subject}">ê³¼ëª©ëª…</span> <span
							th:if="${#lists.isEmpty(weakSubjects)}" class="no-data">ì—†ìŒ</span>
					</div>
				</div>
				<div class="strong-subjects">
					<h3>ìš°ìˆ˜ ê³¼ëª©</h3>
					<div class="subject-tags">
						<span th:each="subject : ${strongSubjects}"
							class="subject-tag strong" th:text="${subject}">ê³¼ëª©ëª…</span> <span
							th:if="${#lists.isEmpty(strongSubjects)}" class="no-data">ì—†ìŒ</span>
					</div>
				</div>
			</div>

			<div class="difficulty-message">
				<th:block
					th:with="accuracy=${result.correctCount * 100.0 / (result.correctCount + result.wrongCount)}">
					<p th:if="${accuracy >= 80}" class="msg-up">ğŸ‰ ìš°ìˆ˜í•œ ì„±ì ì…ë‹ˆë‹¤! ë‹¤ìŒ
						ì‹œí—˜ì€ ë‚œì´ë„ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤.</p>
					<p th:if="${accuracy < 60}" class="msg-down">ğŸ’ª ì¡°ê¸ˆ ë” ê¸°ì´ˆë¥¼ ë‹¤ì ¸ë´…ì‹œë‹¤.
						ë‹¤ìŒ ì‹œí—˜ì€ ë‚œì´ë„ê°€ í•˜ë½í•©ë‹ˆë‹¤.</p>
					<p th:if="${accuracy >= 60 and accuracy < 80}" class="msg-same">
						ğŸ‘ ì ì ˆí•œ ë‚œì´ë„ë¡œ í•™ìŠµ ì¤‘ì…ë‹ˆë‹¤.</p>
				</th:block>
			</div>

			<!-- ì•¡ì…˜ ë²„íŠ¼ -->
			<div class="action-buttons">
				<button class="btn-recommend" th:onclick="|goToRecommend()|">
					ì·¨ì•½ê³¼ëª© ê°•ì˜ì¶”ì²œ</button>
				<button class="btn-explanation"
					th:onclick="|goToExplanation(${result.resultIdx})|">í•´ì„¤ë³´ê¸°</button>
			</div>

			<div class="bottom-buttons">
				<button class="btn-main" onclick="location.href='/main'">ë©”ì¸ìœ¼ë¡œ</button>
				<button class="btn-exam" onclick="location.href='/exam/my-results'">ì‹œí—˜
					ëª©ë¡</button>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		/*<![CDATA[*/
		const weakSubjects = /*[[${weakSubjects}]]*/[];
		const resultIdx = /*[[${result.resultIdx}]]*/0;

		function goToRecommend() {
			if (weakSubjects.length === 0) {
				alert('ì·¨ì•½ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤!');
				return;
			}

			// NotionCompleteì²˜ëŸ¼ sessionStorage ì‚¬ìš©
			const payload = {
				tags : weakSubjects,
				searchMode : 'OR'
			};
			sessionStorage.setItem('lectureRecommendPayload', JSON
					.stringify(payload));
			location.href = '/lecture/recommend';
		}

		function goToExplanation(resultIdx) {
			location.href = `/exam/explanation/${resultIdx}`;
		}
		/*]]>*/
	</script>
</body>
</html>
