<!-- src/main/resources/templates/fragments/header.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="UTF-8">
<head>
    <!-- ì™¸ë¶€ CSS íŒŒì¼ ì—°ê²° -->
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<style>
	.chat-button {
		display: inline-block;
		margin-top: 10px;
		padding: 8px 16px;
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		text-decoration: none;
		border-radius: 8px;
		font-weight: 500;
		transition: transform 0.2s;
	}

	.chat-button:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
	}
</style>
<!-- WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ CDN -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@6.1.0/bundles/stomp.umd.min.js"></script>

<!-- ì•Œë¦¼ ì‹œìŠ¤í…œ CSS -->
<style>
/* ì•Œë¦¼ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
.notification-icon {
    position: relative;
    cursor: pointer;
    padding: 8px;
    margin-right: 15px;
}

.notification-badge {
    position: absolute;
    top: 0;
    right: 0;
    background: #ff4757;
    color: white;
    border-radius: 50%;
    min-width: 18px;
    height: 18px;
    font-size: 11px;
    display: none;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    line-height: 1;
}

.notification-icon:hover {
    background: rgba(0,0,0,0.1);
    border-radius: 4px;
}

/* ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ */
.notification-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    width: 320px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.notification-header {
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    font-weight: bold;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.notification-list {
    max-height: 300px;
    overflow-y: auto;
}

.notification-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
}

.notification-item:hover {
    background: #f8f9fa;
}

.notification-item.unread {
    background: #f0f8ff;
    border-left: 3px solid #007bff;
}

.notification-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: #333;
}

.notification-message {
    font-size: 13px;
    color: #666;
    margin-bottom: 4px;
}

.notification-time {
    font-size: 11px;
    color: #999;
}

.notification-empty {
    padding: 40px 16px;
    text-align: center;
    color: #999;
}

/* ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ë°”ë„ˆ */
.notification-permission-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 20px;
    text-align: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 9999;
    transform: translateY(-100%);
    transition: transform 0.3s ease;
}

.notification-permission-banner.show {
    transform: translateY(0);
}

.permission-banner-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}

.permission-banner-text {
    flex: 1;
    min-width: 200px;
}

.permission-banner-buttons {
    display: flex;
    gap: 10px;
}

.permission-btn {
    padding: 6px 16px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
}

.permission-btn.allow {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
}

.permission-btn.allow:hover {
    background: rgba(255,255,255,0.3);
}

.permission-btn.deny {
    background: transparent;
    color: rgba(255,255,255,0.8);
    border: 1px solid rgba(255,255,255,0.2);
}

.permission-btn.deny:hover {
    background: rgba(255,255,255,0.1);
}
</style>

<!-- ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ë°°ë„ˆ HTML (body ì‹œì‘ ì§í›„ì— ì¶”ê°€) -->
<div class="notification-permission-banner" id="notificationPermissionBanner">
    <div class="permission-banner-content">
        <div class="permission-banner-text">
            ğŸ”” ì‹¤ì‹œê°„ ì¼ì • ì•Œë¦¼ì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ? ì¤‘ìš”í•œ ì¼ì •ì„ ë†“ì¹˜ì§€ ì•Šë„ë¡ ë„ì™€ë“œë¦½ë‹ˆë‹¤!
        </div>
        <div class="permission-banner-buttons">
            <button class="permission-btn allow" onclick="allowNotifications()">í—ˆìš©</button>
            <button class="permission-btn deny" onclick="denyNotifications()">ë‚˜ì¤‘ì—</button>
        </div>
    </div>
</div>

<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°”ì˜ ì˜¤ë¥¸ìª½ì— ì•Œë¦¼ ì•„ì´ì½˜ ì¶”ê°€ (ê¸°ì¡´ ì‚¬ìš©ì ë©”ë‰´ ì•ì—) -->
<div class="notification-icon" onclick="toggleNotificationDropdown()" style="position: relative;">
    <i class="fas fa-bell" style="font-size: 18px; color: #666;"></i>
    <span class="notification-badge" id="notificationBadge">0</span>

    <!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ -->
    <div class="notification-dropdown" id="notificationDropdown">
        <div class="notification-header">
            <span>ì•Œë¦¼</span>
            <button onclick="markAllAsRead()" style="float: right; background: none; border: none; color: #007bff; cursor: pointer; font-size: 12px;">
                ëª¨ë‘ ì½ìŒ
            </button>
        </div>
        <div class="notification-list" id="notificationList">
            <div class="notification-empty">
                ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>
</div>

<!-- ì‚¬ìš©ì IDë¥¼ JavaScriptì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ hidden ë°ì´í„° ì¶”ê°€ -->
<div data-user-id="${userIdx}" style="display: none;"></div>

<!-- notification.js ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
<script src="/js/notification.js"></script>

<!-- ì•Œë¦¼ ê´€ë ¨ JavaScript í•¨ìˆ˜ë“¤ -->
<script>
// ì•Œë¦¼ ê¶Œí•œ í—ˆìš©
async function allowNotifications() {
    const banner = document.getElementById('notificationPermissionBanner');
    banner.classList.remove('show');

    if (notificationManager) {
        const granted = await notificationManager.requestNotificationPermission();
        if (granted) {
            // ê¶Œí•œì´ í—ˆìš©ë˜ë©´ ë°°ë„ˆ ì™„ì „íˆ ìˆ¨ê¹€
            banner.style.display = 'none';
            localStorage.setItem('notificationPermissionAsked', 'granted');
        }
    }
}

// ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ (ë‚˜ì¤‘ì—)
function denyNotifications() {
    const banner = document.getElementById('notificationPermissionBanner');
    banner.classList.remove('show');

    // í•˜ë£¨ ë™ì•ˆ ë¬»ì§€ ì•Šê¸°
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    localStorage.setItem('notificationPermissionAsked', tomorrow.getTime());
}

// ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ í† ê¸€
function toggleNotificationDropdown() {
    const dropdown = document.getElementById('notificationDropdown');
    const isVisible = dropdown.style.display === 'block';

    // ë‹¤ë¥¸ ë“œë¡­ë‹¤ìš´ë“¤ ë‹«ê¸°
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
    });

    dropdown.style.display = isVisible ? 'none' : 'block';

    if (!isVisible) {
        loadNotificationHistory();
    }
}

// ì•Œë¦¼ íˆìŠ¤í† ë¦¬ ë¡œë“œ
function loadNotificationHistory() {
    const list = document.getElementById('notificationList');

    if (notificationManager && notificationManager.notifications.length > 0) {
        list.innerHTML = notificationManager.notifications
            .slice(0, 10) // ìµœê·¼ 10ê°œë§Œ
            .map(notification => `
                <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="handleNotificationClick('${notification.type}', ${notification.read})">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
                </div>
            `).join('');
    } else {
        list.innerHTML = '<div class="notification-empty">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
}

// ì•Œë¦¼ í´ë¦­ ì²˜ë¦¬
function handleNotificationClick(type, isRead) {
    // ì½ìŒ ì²˜ë¦¬
    if (!isRead && notificationManager) {
        notificationManager.updateNotificationBadge();
    }

    // íƒ€ì…ë³„ í˜ì´ì§€ ì´ë™
    switch(type) {
        case 'schedule':
            window.open('/schedule/manager', '_blank');
            break;
        case 'chatbot':
            // ì±—ë´‡ ëª¨ë‹¬ ì—´ê¸°
            if (window.openChatbot) {
                window.openChatbot();
            }
            break;
    }

    // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.getElementById('notificationDropdown').style.display = 'none';
}

// ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
function markAllAsRead() {
    if (notificationManager) {
        notificationManager.notifications.forEach(n => n.read = true);
        notificationManager.updateNotificationBadge();
        loadNotificationHistory();
    }
}

// ì•Œë¦¼ ì‹œê°„ í¬ë§·íŒ…
function formatNotificationTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);

    if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
    if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}ì‹œê°„ ì „`;
    return date.toLocaleDateString('ko-KR');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ê¶Œí•œ ë°°ë„ˆ í‘œì‹œ ì—¬ë¶€ í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
    const banner = document.getElementById('notificationPermissionBanner');
    const asked = localStorage.getItem('notificationPermissionAsked');

    if (!asked || asked === 'denied') {
        if (!asked) {
            // ì²˜ìŒ ë°©ë¬¸ ì‹œ 3ì´ˆ í›„ ë°°ë„ˆ í‘œì‹œ
            setTimeout(() => {
                banner.classList.add('show');
            }, 3000);
        } else if (asked !== 'granted' && new Date().getTime() > parseInt(asked)) {
            // ê±°ë¶€í–ˆì§€ë§Œ ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ë‹¤ì‹œ í‘œì‹œ
            setTimeout(() => {
                banner.classList.add('show');
            }, 3000);
        }
    }
});

// ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
document.addEventListener('click', function(e) {
    if (!e.target.closest('.notification-icon')) {
        document.getElementById('notificationDropdown').style.display = 'none';
    }
});
</script>
</head>
<body>
<header th:fragment="siteHeader">
	<div class="header-wrapper">
	    <div class="header-top">
	    	<div class ="header-top-right">
		        <a th:href="@{/main}" class="logo"><img th:src="@{/images/logo2.png}" class="logo-image"/></a>
		        <!-- ì¹´í…Œê³ ë¦¬ ë©”ë‰´ -->
		        <div class="categori-container">
		            <a th:href="@{/main}" th:classappend="${activeMenu == 'main'} ? ' active' : ''">ë©”ì¸í™”ë©´</a>
		            <a th:href="@{/notion/create}" th:classappend="${activeMenu == 'notionCreate'} ? ' active' : ''">ë…¸íŠ¸ì‘ì„±</a>
		            <a th:href="@{/notion/manage}" th:classappend="${activeMenu == 'notionManage'} ? ' active' : ''">ë…¸íŠ¸ê´€ë¦¬</a>
		            <a th:href="@{/exam/create}" th:classappend="${activeMenu == 'quizCreate'} ? ' active' : ''">ë¬¸ì œìƒì„±</a>
		            <a th:href="@{/exam/my-results}" th:classappend="${activeMenu == 'examList'} ? ' active' : ''">ì‹œí—˜ëª©ë¡</a>

		            <a th:href="@{/schedule}" th:classappend="${activeMenu == 'schedule'} ? ' active' : ''">ì¼ì •ê´€ë¦¬</a>
		            <a th:href="@{/recomLecture}" th:classappend="${activeMenu == 'recomLecture'} ? active : ''">ê°•ì˜ëª©ë¡</a>
		            <a th:href="@{/market}" th:classappend="${activeMenu == 'market'} ? active : ''">ë§ˆì¼“ì´ë™</a>
		        </div>

	    	</div>
	        <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ -->
	        <div class="login-container">
	            <div sec:authorize="isAnonymous()">
	                <a th:href="@{/login}" class="login-button">ë¡œê·¸ì¸</a>
	            </div>
	            <div sec:authorize="isAuthenticated()" class="login-button-location">
	            	<div class="out-user-name" th:text="${nickname} + 'ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.'">OOOë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.</div>
	            	<div class="userProfile-container">
						  <button class="userProfile-btn" id="profileBtn">
						    <img th:src="@{/images/default-profile.png}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="user-image-container" />
						  </button>

						  <!-- â–¼ í´ë¦­ ì‹œ ë‚˜íƒ€ë‚  ë“œë¡­ë‹¤ìš´ -->
						  <div class="dropdown-menu" id="dropdownMenu">
						  		<div class="user-location-container">
						  			<div class="email-container" th:text="${email}"> </div>
						  			<div class="profile-img-location-container">
								  		<img th:src="@{/images/default-profile.png}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-image" />
						  			</div>
							  		<div class="user-name" th:text="${nickname} + 'ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.'">OOOë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.</div>
							  		<div class="point-container">
								  		<div class="user-credit" th:text="9999"></div><div>ğŸª™</div>
								  		<div class="user-gold" th:text="9999 "></div><div>ğŸ’</div>
							  		</div>
							  		<div class="user-btn-container">
								    	<a th:href="@{/mypage}" class="dropdown-item1">ë§ˆì´í˜ì´ì§€</a>
								    	<a th:href="@{/logout}" class="dropdown-item2">ë¡œê·¸ì•„ì›ƒ</a>
							  		</div>
						  		</div>
						  </div>
	  				</div>
			  		<button id="theme-toggle-btn" class="mode-changeBtn"></button>
	  			</div>
	        </div>
	    </div>
	</div>

    <div class="AI-position-container">
	  <div class="AI-container">
	    <a class="AI-button" id="aiButton">
	      <img th:src="@{/images/AI.png}" class="AI-image png-mode" id="haiImage" />
	    </a>
	  </div>
	</div>

    <div class="top-button-position-container">
        <button class ="top-button">TOP</button>
    </div>
    <!-- aiëª¨ë‹¬ êµ¬ì¡° -->
	<div class="gpt-modal-overlay" id="gptModal" sec:authorize="isAuthenticated()">
		<div class="gpt-modal-content">
			<div class="gpt-modal-header">
				<span>AI í•™ìŠµ ë„ìš°ë¯¸</span>
				<div style="display: flex; gap: 10px; align-items: center;">
					<button onclick="startNewChat()" style="background: none; border: none; color: white; cursor: pointer; font-size: 0.9rem;">
						ğŸ”„ ìƒˆ ëŒ€í™”
					</button>
					<button class="gpt-close-btn" id="closeModal">Ã—</button>
				</div>
			</div>
			<div class="gpt-chat-body" id="chatBody">
				<div class="message bot">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
			</div>
			<div class="gpt-input-area">
				<input type="text" id="userInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
				<button id="sendBtn">ì „ì†¡</button>
			</div>
		</div>
	</div>

 <script>
	const topButtonContainer = document.querySelector('.top-button-position-container');
	const topButton = document.querySelector('.top-button');

	topButtonContainer.style.display = 'none';
	// ìŠ¤í¬ë¡¤ ê°ì§€: 300px ì´ìƒ ë‚´ë ¤ê°€ë©´ ë²„íŠ¼ ë³´ì´ê¸°
	window.addEventListener('scroll', () => {
	    if (window.scrollY > 300) {
	        topButtonContainer.style.display = 'block';
	    } else {
	        topButtonContainer.style.display = 'none';
	    }
	});

	// í´ë¦­ ì‹œ ë¶€ë“œëŸ½ê²Œ ë§¨ ìœ„ë¡œ ì´ë™
	topButton.addEventListener('click', () => {
	    window.scrollTo({
	        top: 0,
	        behavior: 'smooth'
	    });
	});

document.addEventListener('DOMContentLoaded', function() {
  const profileBtn = document.getElementById('profileBtn');
  const dropdownMenu = document.getElementById('dropdownMenu');

  let isOpen = false;

  // âœ… í´ë¦­ ì‹œ í† ê¸€
  profileBtn.addEventListener('click', function(event) {
    event.stopPropagation();
    isOpen = !isOpen;
    dropdownMenu.style.display = isOpen ? 'flex' : 'none';
    updateDropdownPosition();
  });

  // âœ… ìŠ¤í¬ë¡¤í•  ë•Œ ìœ„ì¹˜ ê°±ì‹ 
  window.addEventListener('scroll', function() {
    if (isOpen) updateDropdownPosition();
  });

  // âœ… í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œì—ë„ ê°±ì‹ 
  window.addEventListener('resize', function() {
    if (isOpen) updateDropdownPosition();
  });

  // âœ… ë“œë¡­ë‹¤ìš´ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
  document.addEventListener('click', function() {
    dropdownMenu.style.display = 'none';
    isOpen = false;
  });

  // âœ… ìœ„ì¹˜ ê³„ì‚° í•¨ìˆ˜
  function updateDropdownPosition() {
    const rect = profileBtn.getBoundingClientRect();
    dropdownMenu.style.position = 'fixed';
    dropdownMenu.style.top = `${rect.bottom + 5}px`;
    dropdownMenu.style.left = `${rect.left + window.scrollX - (dropdownMenu.offsetWidth - rect.width)}px`;
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const aiButton = document.getElementById('aiButton');
  const aiImage = document.getElementById("haiImage"); // aiImage ë³€ìˆ˜ ì„ ì–¸ í™•ì¸!
  const pngPath = "/images/AI.png";
  const gifPath = "/images/AI.gif";

  if (aiButton && aiImage) {
      aiButton.addEventListener("click", () => {

          // ğŸ’¡ ëª¨ë‹¬ ì—´ê¸° ë¡œì§ì€ chatbot.jsì—ì„œ ë‹´ë‹¹í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” GIF ì „í™˜ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
          //    ë‹¨, ì´ í´ë¦­ ì´ë²¤íŠ¸ëŠ” GIF ì „í™˜ì´ í•„ìš”í•  ë•Œë§ˆë‹¤ ì‹¤í–‰ë©ë‹ˆë‹¤.

          // ì¤‘ë³µ ë°©ì§€ ì²´í¬ëŠ” ìœ ì§€
          if (aiImage.src.includes("AI.gif")) return;

          // âœ… ìºì‹œ ë¬´ë ¥í™” íŒŒë¼ë¯¸í„° ì¶”ê°€
          const gifPathWithCacheBuster = gifPath + '?' + new Date().getTime();

          // ì´ë¯¸ì§€ & ìŠ¤íƒ€ì¼ ì „í™˜
          aiImage.src = gifPathWithCacheBuster; // ìºì‹œ ë¬´ë ¥í™”ëœ ê²½ë¡œ ì‚¬ìš©
          aiImage.classList.remove("png-mode");
          aiImage.classList.add("gif-mode");

          // 3ì´ˆ í›„ ë³µê·€
          setTimeout(() => {
            aiImage.src = pngPath;
            aiImage.classList.remove("gif-mode");
            aiImage.classList.add("png-mode");
          }, 4000);
      });
  }
});
</script>
	<script th:src="@{/js/marked.min.js}"></script>
<script th:src="@{/js/chatbot.js}"></script>
</header>
</body>
</html>
